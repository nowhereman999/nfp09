;
; TTL  'GET AND PUT ARGUMENTS FROM USER MEMORY'
; NAM  GETPUT
;
;   G E T P U T
;
;       THIS SOURCE INCLUDES 2 CALLABLE SUBROUTINES
;       THAT AID THE FRONT AND BACKEND PROCESSORS
;       TO GET AND PUT ARGUMENTS FROM USER MEMORY TO
;       THE INTERNAL STACK FRAME
;         1. GETARG
;         2. MOVRSL
;
;   MAJOR REVISIONS:
;     REVISER    DATE     REASON
;   JOEL BONEY  021480   ORIGINAL
;   JOEL BONEY  070280   SIZE REDUCTION
;   JOEL BONEY  071080   MORE SIZE REDUCTION
;   JOEL BONEY  072080   FIXED MOVRSL TO RETURN DENRM. NBRS.
;   JOEL BONEY  072580   MOD IREG/ISTACK TO SAVE PARAMETER WD.
;   JOEL BONEY  081480   REMOVE BIAS FROM EXTENDED DENORMALIZED.
;   JOEL BONEY  081980   IMPROVE PERFORMANCE
;   JOEL BONEY  082680   MOVE CODE THAT COPIES TSTAT TO FPCB
;                        FROM 'CLSTAK' TO 'TRAP'.
;   JOEL BONEY  082680   DONAN CALLS IOPSET INSTEAD OF IOP
;   JOEL BONEY  082980   UPDATE TO DRAFT 6.0. RM AND RP NO LONGER
;                        FORCE NORMALIZE MODE.
;   GREG S      103080   ASSURE THAT THE MSBIT OF EXTENDED INF'S
;                        IS A DON'T CARE.
;   GREG S      121680   INSERT TEST SO EXT. NORMALIZED VALUES
;                        AT MIN. EXP. DON'T GET TYPED AS NOT NORM.
;   @thorpej   6-26-22   Updated for asm6809.  New
;                        comments are in mixed-case.
;
;   COPYRIGHT (C) 1980 BY MOTOROLA
;
;
;*****************************************************************
;
;  LINKING LOADER DEFINITIONS
;
;  XDEF  GETARG,MOVRSL,TRAP,IREG,ISTACK,CLSTAK
;  XREF  SNORM,LNORM,TFRACT,PREC,IOPSUB,IOPSET
;
;*****************************************************************
;
;   G E T A R G
;
;     GET AN ARGUMENT FROM USER MEMORY AND PUT IT IN THE
;     STACK FRAME. DO THE NECESSARY EXPANSION TO INTERNAL
;     FORMAT. IF A NAN OCCURS, CHECK FOR A TRAPPING NAN.
;     IF THE ARGUMENT IS DENORMALIZED, CHECK TO SEE IF
;     IT SHOULD BE NORMALIZED DURING THE EXPANSION.
;
; ON ENTRY:
;     X = POINTER TO LOCATION OF ARGUMENT ON STACK FRAME
;     Y = POINTER TO ARGUMENT IN USER MEMORY
;     U = POINTER TO STACK FRAME
;     FOR CMP B=0 FOR ARG1; B.NE.0 FOR ARG2
;     FOR MOV B=0 FOR ARG2; B.NE.0 FOR RESULT
;     FOR OTHER FUNCTION B= DON'T CARE
;
; ON EXIT:
;     ALL REGISTERS RESTORED EXCEPT CC BITS
;     C = 1 NO TRAPPING NAN OCCURED OR TRAP HANDLER WANTS
;           US TO PROCEED.
;     C = 0 TRAPPING NAN OCCURED AND THE TRAP HANDLER
;           WANTS TO ABORT
;
; NOTE:
;     SINCE GETARG IS CALLED BY NEARLY EVERY FUNCTION, AND
;     SINCE CONSIDERABLE TIME COULD BE SPENT EXPANDING THE
;     ARGUMENTS, GETARG IS WRITTEN TO BE AS FAST AS IS
;     REASONABLY POSSIBLE. CONSIDERABLE BYTE SAVINGS CAN
;     BE OBTAINED IF THE MODIFIER WISHES TO SACRIFICE SPEED.
;
;*****************************************************************
;
; THE MAIN PART OF GETARG DETERMINES THE PRECISION OF THE ARGUMENT
; AND THEN CALLS THE APPROPRIATE SUBROUTINE TO HANDLE
; THAT PRECISION OF ARGUMENT
;
GETARG
	; XXXJRT

;*****************************************************************
;
;  M O V E  R E S U L T
;
;  MOVE RESULT ON STACK FRAME TO USER MEMORY. DO THE
;  NECESSARY COMPACTION TO MEMORY FORMAT.
;
;  ON ENTRY:
;    X = POINTER TO RESULT IN USER MEMORY
;    U = POINTER TO STACK FRAME
;
;  ON EXIT:
;    ALL REGISTERS RESTORED
;
;*****************************************************************
MOVRSL
	; XXXJRT

;*****************************************************************
;
;  T R A P
;
;    CHECK FOR ENABLED TRAPS. GO TO TRAP HANDLER IF TRAP FOUND.
;    IF TRAP OCCURS, THE TRAP HANDLER WILL RECEIVE AN INDEX
;    IN THE A-REGISTER OF:
;       0  INVALID OPERATION
;       1  OVERFLOW
;       2  UNDERFLOW
;       3  DIVIDE BY ZERO
;       4  UNORDERED
;       5  INTEGER OVERFLOW
;       6  INEXACT
;
;    IF MORE THAN ONE ENABLED TRAP OCCURED, THE ONE WITH THE
;    HIGHEST PRIORITY IS TAKEN. 0 HAS HIGHEST PRIORITY AND
;    6 THE LOWEST.
;
;    FOR COMPARES THAT TRAP ON UNORDERED, UNORDERED WILL
;    WILL BE ENABLED FOR THE DURATION OF THIS
;    ROUTINE (NOT PERMANENTLY).
;
;
;  ON ENTRY:
;    U POINTS TO STACK FRAME
;
;  ON EXIT:
;    C = 1 IF NO TRAP OCCURED OR USER TRAP HANDLER WANTS
;          US TO CONTINUE WITH THE ARGUMENT.
;    C = 0 IF TRAP OCCURED AND USER DOES NOT WANT US TO
;          RETURN A RESULT OR TO CONTINUE.
;    CC IS DESTROYED ON EXIT
;
;*****************************************************************
TRAP
	; XXXJRT

;*****************************************************************
;
; I R E G
;
;   INITIALIZE THE STACK FRAME ON A REGISTER CALL. CREATE THE
;   STACK FRAME AND INITIALIZE MANY OF THE LOCATIONS IN THE
;   STACK FRAME.
;
;   ON ENTRY:
;      A CONTAINS THE FUNCTION NUMBER
;      X CONTAINS TPARAM IF MOVE OR COMPARE
;
;   ON EXIT:
;      ALL REGISTERS RESTORED
;      U-REG POINTS TO NEWLY CREATED STACK FRAME
;
;*****************************************************************
IREG
	LEAS	-FRMSIZ,S	; CARVE OFF SPACE FOR STACK FRAME
	LDU	DREG,S		; LOAD PTR TO FPCB
;
;   MUTUAL CODE ALSO SHARED BY ISTACK.
;   ASSUMES D IS ON THE STACK WHEN ENTERING HERE
;
IXIT
	STU	PFPCB,S		; STORE PTR TO FPCB
	STA	FUNCT,S		; SAVE FUNCTION NBR.
	STX	TPARAM,S	; SAVE PARAMETER WD (IF ANY)
; CLEAR ALL STACK FRAME ENTRIES FROM 'TYPE1'
; DOWN TO AND INCLUDING STIKY
	LEAU	TYPE1+1,S	; GET PTR TO TOP OF AREA TO CLEAR
	PSHS	D,X,Y		; SAVE REGS
	LDD	#0		; D=0
	LDX	#0		; D,X, AND Y ARE CLEARED (6 BYTES)
	LEAY	,X		; Y=0 TOO
; FAST CLEAR TAKES 75 CYLES
	PSHU	D,X,Y
	PSHU	D,X,Y		; 6 * 6 = 36 BYTES
	PSHU	D,X,Y
	PSHU	D,X,Y
	PSHU	D,X,Y
	PSHU	D,X,Y
	PSHU	D,X		; + 4 MORE MAKES 40
	LEAU	6,S		; U NOW POINTS TO STACK FRAME
	STX	TSTAT,U		; CLEAR TSTAT
	INCB			; B=1 (RESULT PRECISION)
	LBSR	PREC		; GET PRECISION OF RESULT
	STB	RPREC,U
	PULS	D,X,Y		; RESTORE REGS
	JMP	[ISTKPC,U]	; RETURN THRU PC ON STACK

;*****************************************************************
;
; I S T A C K
;
;   INIT STACK FRAME FOR STACK CALL. RESERVES SPACE ON THE
;   STACK AND INITIALIZES SOME VARIABLES.
;
;   ON ENTRY;
;     A CONTAINS THE FUNCTION NBR.
;     Y CONTAINS A POINTER TO THE TOP OF STACK (TOS). ASSUMES
;       THE POINTER TO THE FPCB IS AT TOS-2
;
;   ON EXIT:
;     U-REG POINTS TO STACK FRAMES
;     ALL OTHER REGISTERS RESTORED EXCEPT CC
;
;*****************************************************************
ISTACK
	LEAS	-FRMSIZ,S	; CARVE OFF SPACE FOR STACK FRAME
	STY	PTOS,S		; SAVE TOS PTR
	LDU	-2,Y		; LOAD PTR TO FPCB
	BRA	IXIT		; GO TAKE MUTUAL EXIT WITH IREG

;*****************************************************************
;
; C L S T A K
;
;  CLOSE STACK FRAME. POP THE WHOLE STACK FRAME OFF OF THE STACK
;  BACK TO THE USER'S CCREG
;
;  CAUTION: ANYTHING ON THE STACK BELOW THE STACK
;           FRAME WILL BE LOST
;
;  X IS DESTROYED
;
;*****************************************************************
CLSTAK
	LDX	,S		; GET RETURN ADDRESS
	LEAS	,U		; CARVE UP TO U
	LEAS	FRMSIZ+2,S	; POP STACK FRAME PLUS IREGPC OR ISTKPC
	JMP	,X		; EXIT
